name: Generate Snippets - Manual Trigger

on:
  workflow_dispatch:
    inputs:
      blog_ids:
        description: 'Comma-separated blog IDs (leave empty for pending blogs)'
        required: false
        default: ''
      limit:
        description: 'Number of blogs to process (if blog_ids not provided)'
        required: false
        default: '10'

jobs:
  generate-snippets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Queue blogs for processing
        id: queue
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          API_URL: ${{ secrets.API_URL || 'https://astrologyapp.in' }}
          BLOG_IDS: ${{ github.event.inputs.blog_ids }}
          LIMIT: ${{ github.event.inputs.limit || '10' }}
        run: |
          if [ -n "$BLOG_IDS" ]; then
            echo "üìã Queueing specific blog IDs: $BLOG_IDS"
            BLOG_IDS_JSON=$(echo "[$BLOG_IDS]" | sed 's/,/,/g')
            response=$(curl -s -X POST "$API_URL/api/admin/generate-snippets" \
              -H "Content-Type: application/json" \
              -H "x-admin-key: $ADMIN_SECRET" \
              -d "{\"blog_ids\": $BLOG_IDS_JSON}")
          else
            echo "üìã Queueing pending blogs (limit: $LIMIT)"
            response=$(curl -s -X POST "$API_URL/api/admin/generate-snippets" \
              -H "Content-Type: application/json" \
              -H "x-admin-key: $ADMIN_SECRET" \
              -d "{\"limit\": $LIMIT}")
          fi
          echo "$response" | jq '.'
          echo "queued_response<<EOF" >> $GITHUB_OUTPUT
          echo "$response" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Process snippets via backend
        id: process
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          BACKEND_URL: ${{ secrets.BACKEND_URL || 'https://ameetspeaks-astrologyapp.hf.space' }}
          LIMIT: ${{ github.event.inputs.limit || '10' }}
        run: |
          echo "üöÄ Starting snippet generation on backend..."
          echo "Backend URL: $BACKEND_URL"
          echo "Batch size: $LIMIT"
          echo "Endpoint: $BACKEND_URL/api/snippets/process-batch"
          
          # Remove trailing slash from BACKEND_URL if present
          BACKEND_URL=$(echo "$BACKEND_URL" | sed 's|/$||')
          
          # Get response with HTTP status code (follow redirects with -L)
          temp_file=$(mktemp)
          http_code=$(curl -s -L -w "%{http_code}" -o "$temp_file" -X POST "$BACKEND_URL/api/snippets/process-batch?batch_size=$LIMIT" \
            -H "Content-Type: application/json" \
            -H "x-admin-key: $ADMIN_SECRET")
          body=$(cat "$temp_file")
          rm -f "$temp_file"
          
          echo "HTTP Status: $http_code"
          echo "Response body:"
          echo "$body"
          
          # Validate http_code is numeric
          if ! [[ "$http_code" =~ ^[0-9]+$ ]]; then
            echo "‚ùå Invalid HTTP status code: $http_code"
            echo "Full response: $body"
            exit 1
          fi
          
          if [ "$http_code" -eq 200 ]; then
            # Try to parse as JSON
            if echo "$body" | jq . >/dev/null 2>&1; then
              echo "$body" | jq '.'
              echo "process_response<<EOF" >> $GITHUB_OUTPUT
              echo "$body" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              
              blog_ids=$(echo "$body" | jq -r '.ids[]?' 2>/dev/null | tr '\n' ',' | sed 's/,$//')
              if [ -n "$blog_ids" ] && [ "$blog_ids" != "null" ] && [ "$blog_ids" != "" ]; then
                echo "blog_ids=$blog_ids" >> $GITHUB_OUTPUT
                echo "üìù Tracking batch with IDs: $blog_ids"
              else
                echo "‚ö†Ô∏è No blog IDs returned from batch"
                echo "Response: $body"
              fi
            else
              echo "‚ö†Ô∏è Response is not valid JSON"
              echo "Raw response: $body"
            fi
          elif [ "$http_code" -eq 301 ] || [ "$http_code" -eq 302 ]; then
            echo "‚ö†Ô∏è Redirect detected (HTTP $http_code)"
            echo "Trying alternative endpoint: /api/snippets/process-pending"
            
            # Try alternative endpoint
            alt_response=$(curl -s -L -w "\n%{http_code}" -X POST "$BACKEND_URL/api/snippets/process-pending?limit=$LIMIT" \
              -H "Content-Type: application/json" \
              -H "x-admin-key: $ADMIN_SECRET" 2>&1)
            
            alt_http_code=$(echo "$alt_response" | tail -n1)
            alt_body=$(echo "$alt_response" | sed '$d')
            
            if [ "$alt_http_code" -eq 200 ]; then
              echo "‚úÖ Alternative endpoint worked!"
              echo "$alt_body" | jq '.' 2>/dev/null || echo "$alt_body"
            else
              echo "‚ùå Alternative endpoint also failed (HTTP $alt_http_code)"
              echo "Response: $alt_body"
              echo "‚ö†Ô∏è Backend may not be deployed or endpoint path is incorrect"
              exit 1
            fi
          else
            echo "‚ùå Backend returned error (HTTP $http_code)"
            echo "Response: $body"
            echo "‚ö†Ô∏è Check if backend is deployed and endpoint exists: $BACKEND_URL/api/snippets/process-batch"
            exit 1
          fi

      - name: Wait and check batch status
        if: steps.process.outputs.blog_ids != '' && steps.process.outputs.blog_ids != 'null'
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          BACKEND_URL: ${{ secrets.BACKEND_URL || 'https://ameetspeaks-astrologyapp.hf.space' }}
          BLOG_IDS: ${{ steps.process.outputs.blog_ids }}
        run: |
          echo "‚è≥ Waiting for batch processing..."
          # Convert comma-separated IDs to JSON array
          ids_array=$(echo "$BLOG_IDS" | tr ',' '\n' | jq -R . | jq -s .)
          
          max_attempts=20
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "üìä Check attempt $attempt/$max_attempts..."
            
            status=$(curl -s -L -X POST "$BACKEND_URL/api/snippets/check-batch" \
              -H "Content-Type: application/json" \
              -H "x-admin-key: $ADMIN_SECRET" \
              -d "{\"ids\": $ids_array}")
            
            echo "$status" | jq '.'
            
            is_done=$(echo "$status" | jq -r '.is_done')
            if [ "$is_done" = "true" ]; then
              echo "‚úÖ Batch processing completed!"
              break
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "‚è∏Ô∏è Waiting 30 seconds before next check..."
              sleep 30
            fi
          done
          
          if [ "$is_done" != "true" ]; then
            echo "‚ö†Ô∏è Batch still processing after $max_attempts attempts."
          fi

      - name: Show results
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          API_URL: ${{ secrets.API_URL || 'https://astrologyapp.in' }}
        continue-on-error: true
        run: |
          echo "Generation completed. Fetching statistics..."
          response=$(curl -s -w "\n%{http_code}" -X GET "$API_URL/api/admin/snippet-stats" \
            -H "x-admin-key: $ADMIN_SECRET")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Statistics:"
            echo "$body" | jq '.stats'
          else
            echo "‚ö†Ô∏è Warning: Could not fetch statistics (HTTP $http_code)"
            echo "Note: The API route may not be deployed yet or needs rebuild"
            echo "Snippet generation was queued successfully"
          fi

      - name: Show results
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          API_URL: ${{ secrets.API_URL || 'https://astrologyapp.in' }}
        continue-on-error: true
        run: |
          echo "Generation completed. Fetching statistics..."
          response=$(curl -s -w "\n%{http_code}" -X GET "$API_URL/api/admin/snippet-stats" \
            -H "x-admin-key: $ADMIN_SECRET")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Statistics:"
            echo "$body" | jq '.stats'
          else
            echo "‚ö†Ô∏è Warning: Could not fetch statistics (HTTP $http_code)"
            echo "Note: The API route may not be deployed yet or needs rebuild"
            echo "Snippet generation was queued successfully"
          fi

