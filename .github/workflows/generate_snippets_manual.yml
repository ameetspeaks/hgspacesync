name: Generate Snippets - Manual Trigger

on:
  workflow_dispatch:
    inputs:
      blog_ids:
        description: 'Comma-separated blog IDs (leave empty for pending blogs)'
        required: false
        default: ''
      limit:
        description: 'Number of blogs to process (if blog_ids not provided)'
        required: false
        default: '10'

jobs:
  generate-snippets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Queue blogs for processing
        id: queue
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          API_URL: ${{ secrets.API_URL || 'https://astrologyapp.in' }}
          BLOG_IDS: ${{ github.event.inputs.blog_ids }}
          LIMIT: ${{ github.event.inputs.limit || '10' }}
        run: |
          if [ -n "$BLOG_IDS" ]; then
            echo "üìã Queueing specific blog IDs: $BLOG_IDS"
            BLOG_IDS_JSON=$(echo "[$BLOG_IDS]" | sed 's/,/,/g')
            response=$(curl -s -X POST "$API_URL/api/admin/generate-snippets" \
              -H "Content-Type: application/json" \
              -H "x-admin-key: $ADMIN_SECRET" \
              -d "{\"blog_ids\": $BLOG_IDS_JSON}")
          else
            echo "üìã Queueing pending blogs (limit: $LIMIT)"
            response=$(curl -s -X POST "$API_URL/api/admin/generate-snippets" \
              -H "Content-Type: application/json" \
              -H "x-admin-key: $ADMIN_SECRET" \
              -d "{\"limit\": $LIMIT}")
          fi
          echo "$response" | jq '.'
          echo "queued_response<<EOF" >> $GITHUB_OUTPUT
          echo "$response" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Process snippets via backend
        id: process
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          BACKEND_URL: ${{ secrets.BACKEND_URL || 'https://ameetspeaks-astrologyapp.hf.space' }}
          LIMIT: ${{ github.event.inputs.limit || '10' }}
        run: |
          echo "üöÄ Starting snippet generation on backend..."
          echo "Backend URL: $BACKEND_URL"
          echo "Batch size: $LIMIT"
          
          # Remove trailing slash if present
          BACKEND_URL="${BACKEND_URL%/}"
          
          # Make the API call (same pattern as other workflows)
          response=$(curl -s -L -w "\n%{http_code}" -X POST "${BACKEND_URL}/api/snippets/process-batch?batch_size=${LIMIT}" \
            -H "Content-Type: application/json" \
            -H "x-admin-key: ${ADMIN_SECRET}" \
            --max-time 300)
          
          # Extract HTTP status code (last line)
          http_code=$(echo "$response" | tail -n1)
          # Extract response body (all but last line)
          body=$(echo "$response" | head -n-1)
          
          echo "üìä Response Status: $http_code"
          echo "üìÑ Response Body: $body"
          
          # Check if request was successful
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "‚úÖ Snippet generation batch queued successfully!"
            if command -v jq &> /dev/null; then
              echo "$body" | jq '.'
            else
              echo "$body"
            fi
            
            # Extract blog IDs for tracking
            if command -v jq &> /dev/null; then
              blog_ids=$(echo "$body" | jq -r '.ids[]?' 2>/dev/null | tr '\n' ',' | sed 's/,$//')
              if [ -n "$blog_ids" ] && [ "$blog_ids" != "null" ] && [ "$blog_ids" != "" ]; then
                echo "blog_ids=$blog_ids" >> $GITHUB_OUTPUT
                echo "üìù Tracking batch with IDs: $blog_ids"
              fi
            fi
          else
            echo "::error::Request failed with status $http_code"
            echo "$body"
            exit 1
          fi

      - name: Wait and check batch status
        if: steps.process.outputs.blog_ids != '' && steps.process.outputs.blog_ids != 'null'
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          BACKEND_URL: ${{ secrets.BACKEND_URL || 'https://ameetspeaks-astrologyapp.hf.space' }}
          BLOG_IDS: ${{ steps.process.outputs.blog_ids }}
        continue-on-error: true
        run: |
          echo "‚è≥ Waiting for batch processing..."
          BACKEND_URL="${BACKEND_URL%/}"
          
          # Convert comma-separated IDs to JSON array
          ids_array=$(echo "$BLOG_IDS" | tr ',' '\n' | jq -R . | jq -s .)
          
          max_attempts=20
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "üìä Check attempt $attempt/$max_attempts..."
            
            status_response=$(curl -s -L -w "\n%{http_code}" -X POST "${BACKEND_URL}/api/snippets/check-batch" \
              -H "Content-Type: application/json" \
              -H "x-admin-key: ${ADMIN_SECRET}" \
              -d "{\"ids\": $ids_array}")
            
            status_http_code=$(echo "$status_response" | tail -n1)
            status_body=$(echo "$status_response" | head -n-1)
            
            if [ "$status_http_code" -eq 200 ]; then
              echo "$status_body" | jq '.'
              is_done=$(echo "$status_body" | jq -r '.is_done')
              if [ "$is_done" = "true" ]; then
                echo "‚úÖ Batch processing completed!"
                break
              fi
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "‚è∏Ô∏è Waiting 30 seconds before next check..."
              sleep 30
            fi
          done

      - name: Show results
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          API_URL: ${{ secrets.API_URL || 'https://astrologyapp.in' }}
        continue-on-error: true
        run: |
          echo "Generation completed. Fetching statistics..."
          response=$(curl -s -w "\n%{http_code}" -X GET "$API_URL/api/admin/snippet-stats" \
            -H "x-admin-key: $ADMIN_SECRET")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Statistics:"
            echo "$body" | jq '.stats'
          else
            echo "‚ö†Ô∏è Warning: Could not fetch statistics (HTTP $http_code)"
            echo "Note: The API route may not be deployed yet or needs rebuild"
            echo "Snippet generation was queued successfully"
          fi

