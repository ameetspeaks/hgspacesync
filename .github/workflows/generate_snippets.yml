name: Generate Snippets from Blogs

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # Manual trigger
    inputs:
      limit:
        description: 'Number of blogs to process'
        required: false
        default: '10'
      force:
        description: 'Force regeneration'
        required: false
        default: 'false'

jobs:
  generate-snippets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Queue existing blogs
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          API_URL: ${{ secrets.API_URL || 'https://astrologyapp.in' }}
        run: |
          curl -X POST "$API_URL/api/admin/queue-existing-blogs" \
            -H "Content-Type: application/json" \
            -H "x-admin-key: $ADMIN_SECRET" \
            -d '{"limit": null}'

      - name: Queue blogs for processing
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          API_URL: ${{ secrets.API_URL || 'https://astrologyapp.in' }}
          LIMIT: ${{ github.event.inputs.limit || '10' }}
        id: queue
        run: |
          echo "üìã Queueing blogs for snippet generation..."
          response=$(curl -s -X POST "$API_URL/api/admin/generate-snippets" \
            -H "Content-Type: application/json" \
            -H "x-admin-key: $ADMIN_SECRET" \
            -d "{\"limit\": $LIMIT, \"force\": false}")
          echo "$response" | jq '.'
          echo "queued_response<<EOF" >> $GITHUB_OUTPUT
          echo "$response" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Process snippets via backend
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          BACKEND_URL: ${{ secrets.BACKEND_URL || 'https://ameetspeaks-astrologyapp.hf.space' }}
          LIMIT: ${{ github.event.inputs.limit || '10' }}
        id: process
        run: |
          echo "üöÄ Starting snippet generation on backend..."
          response=$(curl -s -X POST "$BACKEND_URL/api/snippets/process-batch?batch_size=$LIMIT" \
            -H "Content-Type: application/json" \
            -H "x-admin-key: $ADMIN_SECRET")
          echo "$response" | jq '.'
          echo "process_response<<EOF" >> $GITHUB_OUTPUT
          echo "$response" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Extract blog IDs from response
          blog_ids=$(echo "$response" | jq -r '.ids[]?' | tr '\n' ',' | sed 's/,$//')
          if [ -n "$blog_ids" ]; then
            echo "blog_ids=$blog_ids" >> $GITHUB_OUTPUT
            echo "üìù Tracking batch with IDs: $blog_ids"
          fi

      - name: Wait and check batch status
        if: steps.process.outputs.blog_ids != ''
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          BACKEND_URL: ${{ secrets.BACKEND_URL || 'https://ameetspeaks-astrologyapp.hf.space' }}
          BLOG_IDS: ${{ steps.process.outputs.blog_ids }}
        run: |
          echo "‚è≥ Waiting for batch processing..."
          ids_array=$(echo "$BLOG_IDS" | tr ',' ' ' | xargs -I {} echo '{}' | jq -R . | jq -s .)
          
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "üìä Check attempt $attempt/$max_attempts..."
            
            status=$(curl -s -X POST "$BACKEND_URL/api/snippets/check-batch" \
              -H "Content-Type: application/json" \
              -H "x-admin-key: $ADMIN_SECRET" \
              -d "{\"ids\": $ids_array}")
            
            echo "$status" | jq '.'
            
            is_done=$(echo "$status" | jq -r '.is_done')
            if [ "$is_done" = "true" ]; then
              echo "‚úÖ Batch processing completed!"
              break
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "‚è∏Ô∏è Waiting 30 seconds before next check..."
              sleep 30
            fi
          done
          
          if [ "$is_done" != "true" ]; then
            echo "‚ö†Ô∏è Batch still processing after $max_attempts attempts. Check backend logs."
          fi

      - name: Get statistics
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          API_URL: ${{ secrets.API_URL || 'https://astrologyapp.in' }}
        continue-on-error: true
        run: |
          response=$(curl -s -w "\n%{http_code}" -X GET "$API_URL/api/admin/snippet-stats" \
            -H "x-admin-key: $ADMIN_SECRET")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Statistics retrieved:"
            echo "$body" | jq '.'
          else
            echo "‚ö†Ô∏è Warning: Could not fetch statistics (HTTP $http_code)"
            echo "This is not critical - snippet generation may still be processing"
            echo "Response preview: $(echo "$body" | head -c 200)"
          fi

