name: Generate Snippets from Blogs

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # Manual trigger
    inputs:
      limit:
        description: 'Number of blogs to process'
        required: false
        default: '10'
      force:
        description: 'Force regeneration'
        required: false
        default: 'false'

jobs:
  generate-snippets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Queue existing blogs
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          API_URL: ${{ secrets.API_URL || 'https://astrologyapp.in' }}
        run: |
          curl -X POST "$API_URL/api/admin/queue-existing-blogs" \
            -H "Content-Type: application/json" \
            -H "x-admin-key: $ADMIN_SECRET" \
            -d '{"limit": null}'

      - name: Queue blogs for processing
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          API_URL: ${{ secrets.API_URL || 'https://astrologyapp.in' }}
          LIMIT: ${{ github.event.inputs.limit || '10' }}
        id: queue
        run: |
          echo "üìã Queueing blogs for snippet generation..."
          response=$(curl -s -X POST "$API_URL/api/admin/generate-snippets" \
            -H "Content-Type: application/json" \
            -H "x-admin-key: $ADMIN_SECRET" \
            -d "{\"limit\": $LIMIT, \"force\": false}")
          echo "$response" | jq '.'
          echo "queued_response<<EOF" >> $GITHUB_OUTPUT
          echo "$response" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Process snippets via backend
        id: process
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          BACKEND_URL: ${{ secrets.BACKEND_URL || 'https://ameetspeaks-astrologyapp.hf.space' }}
          LIMIT: ${{ github.event.inputs.limit || '10' }}
        run: |
          echo "üöÄ Starting snippet generation on backend..."
          echo "Backend URL: $BACKEND_URL"
          echo "Batch size: $LIMIT"
          
          # Remove trailing slash if present
          BACKEND_URL="${BACKEND_URL%/}"
          
          # Make the API call (same pattern as other workflows)
          response=$(curl -s -L -w "\n%{http_code}" -X POST "${BACKEND_URL}/api/snippets/process-batch?batch_size=${LIMIT}" \
            -H "Content-Type: application/json" \
            -H "x-admin-key: ${ADMIN_SECRET}" \
            --max-time 300)
          
          # Extract HTTP status code (last line)
          http_code=$(echo "$response" | tail -n1)
          # Extract response body (all but last line)
          body=$(echo "$response" | head -n-1)
          
          echo "üìä Response Status: $http_code"
          echo "üìÑ Response Body: $body"
          
          # Check if request was successful
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "‚úÖ Snippet generation batch queued successfully!"
            if command -v jq &> /dev/null; then
              echo "$body" | jq '.'
            else
              echo "$body"
            fi
            
            # Extract blog IDs for tracking
            if command -v jq &> /dev/null; then
              blog_ids=$(echo "$body" | jq -r '.ids[]?' 2>/dev/null | tr '\n' ',' | sed 's/,$//')
              if [ -n "$blog_ids" ] && [ "$blog_ids" != "null" ] && [ "$blog_ids" != "" ]; then
                echo "blog_ids=$blog_ids" >> $GITHUB_OUTPUT
                echo "üìù Tracking batch with IDs: $blog_ids"
              fi
            fi
          else
            echo "::error::Request failed with status $http_code"
            echo "$body"
            exit 1
          fi

      - name: Wait and check batch status
        if: steps.process.outputs.blog_ids != '' && steps.process.outputs.blog_ids != 'null'
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          BACKEND_URL: ${{ secrets.BACKEND_URL || 'https://ameetspeaks-astrologyapp.hf.space' }}
          BLOG_IDS: ${{ steps.process.outputs.blog_ids }}
        continue-on-error: true
        run: |
          echo "‚è≥ Waiting for batch processing..."
          BACKEND_URL="${BACKEND_URL%/}"
          
          # Convert comma-separated IDs to JSON array of integers
          # Split by comma, convert each to number, create array
          ids_array=$(echo "$BLOG_IDS" | tr ',' '\n' | jq -R 'tonumber' | jq -s '.')
          
          echo "üìã Checking batch with IDs: $ids_array"
          
          max_attempts=20
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "üìä Check attempt $attempt/$max_attempts..."
            
            # Create proper JSON payload
            payload=$(jq -n --argjson ids "$ids_array" '{ids: $ids}')
            
            status_response=$(curl -s -L -w "\n%{http_code}" -X POST "${BACKEND_URL}/api/snippets/check-batch" \
              -H "Content-Type: application/json" \
              -H "x-admin-key: ${ADMIN_SECRET}" \
              -d "$payload")
            
            status_http_code=$(echo "$status_response" | tail -n1)
            status_body=$(echo "$status_response" | head -n-1)
            
            if [ "$status_http_code" -eq 200 ]; then
              echo "$status_body" | jq '.'
              is_done=$(echo "$status_body" | jq -r '.is_done')
              if [ "$is_done" = "true" ]; then
                echo "‚úÖ Batch processing completed!"
                break
              fi
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "‚è∏Ô∏è Waiting 30 seconds before next check..."
              sleep 30
            fi
          done

      - name: Get statistics
        env:
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          API_URL: ${{ secrets.API_URL || 'https://astrologyapp.in' }}
        continue-on-error: true
        run: |
          response=$(curl -s -w "\n%{http_code}" -X GET "$API_URL/api/admin/snippet-stats" \
            -H "x-admin-key: $ADMIN_SECRET")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Statistics retrieved:"
            echo "$body" | jq '.'
          else
            echo "‚ö†Ô∏è Warning: Could not fetch statistics (HTTP $http_code)"
            echo "This is not critical - snippet generation may still be processing"
            echo "Response preview: $(echo "$body" | head -c 200)"
          fi

